<div class="upcoming_productions">

  {% assign current_time = 'now' | date: '%s' | plus: 0 %}
  {% assign next_month_time = 'now' | date: '%s' | plus: 2592000 | plus: 0 %}
  {% assign current_year = 'now' | date: '%Y' %}
  {% assign upcoming_productions = '' | split: '' %}
  {% assign upcoming_showtimes = '' | split: '' %}

  {% for production in site.productions %}
    {% assign production_year = production.year | slice: 0, 4 %}
    {% if production_year == current_year %}
      {% if production.showtimes %}
        {% for showtime in production.showtimes %}
          {% assign showtime_start = showtime | date: '%s' | plus: 0 %}
          {% if showtime_start >= current_time and showtime_start <= next_month_time %}
            {% assign inserted = false %}
            {% for upcoming_showtime in upcoming_showtimes %}
              {% assign upcoming_showtime_seconds = upcoming_showtime | date: '%s' | plus: 0 %}
              {% if showtime_start < upcoming_showtime_seconds %}
                {% assign index = forloop.index0 %}
                {% assign upcoming_productions = upcoming_productions | insert: index, production %}
                {% assign upcoming_showtimes = upcoming_showtimes | insert: index, showtime_start %}
                {% assign inserted = true %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% unless inserted %}
              {% assign upcoming_productions = upcoming_productions | push: production %}
              {% assign upcoming_showtimes = upcoming_showtimes | push: showtime_start %}
            {% endunless %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endif %}
  {% endfor %}

  <!-- Display the sorted productions -->
  {% if upcoming_productions.size > 0 %}
    <ul class="upcoming_productions">
      {% for production in upcoming_productions %}
        <li>
          <a href="{{ production.url }}">{{ production.title }} at {{ production.details.Theatre }}</a>
        </li>
      {% endfor %}
    </ul>
  {% endif %}

</div>